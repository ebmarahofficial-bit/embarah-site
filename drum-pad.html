<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Ebmarah ‚Äì Drum Pad</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" type="image/png" href="assets/favicon.png" />
  <style>
    /* ====== Site base (from your theme) ====== */
    @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700&display=swap');
    :root { --neon:#00ff99; --bg:#020d07; --ink:#e0ffe8; --glass:rgba(2,13,7,.75); }

    * { box-sizing: border-box; }
    html, body { height:100%; margin:0; }
    body {
      font-family:'Orbitron', sans-serif; color:var(--ink);
      background:var(--bg); overflow-x:hidden;
    }

    /* Background video, like other pages */
    .video-bg{ position:fixed; inset:0; z-index:-3; overflow:hidden }
    .video-bg video{ width:100%; height:100%; object-fit:cover; object-position:center; }

    /* Header / nav (desktop) */
    header{
      position:fixed; inset:0 0 auto 0;
      display:flex; align-items:center; justify-content:space-between;
      padding:12px 18px; background:var(--glass);
      border-bottom:1px solid rgba(0,255,128,.2);
      box-shadow:0 6px 24px rgba(0,0,0,.35); z-index:1000;
      backdrop-filter: blur(10px);
    }
    .brand{display:flex; align-items:center; gap:10px; font-weight:800; letter-spacing:.02em}
    .brand img{height:40px; width:auto}
    .brand span{font-size:clamp(16px,2.6vw,22px)}

    nav.site-nav{display:flex; align-items:center; gap:22px}
    nav.site-nav a{
      color:#76ffb2; text-decoration:none; font-weight:700; font-size:clamp(13px,1.6vw,14px)
    }
    nav.site-nav a:hover{ color:#00ffea }

    /* Mobile menu button */
    .menu-btn{
      display:none; background:none; border:1px solid rgba(0,255,128,.35);
      color:#b9ffdf; font-size:16px; font-weight:700; padding:8px 12px; border-radius:10px
    }

    /* Off-canvas drawer (mobile) */
    .drawer-overlay{
      position:fixed; inset:0; background:rgba(0,0,0,.5); z-index:999; opacity:0; pointer-events:none; transition:.25s;
    }
    .drawer{
      position:fixed; top:0; right:-320px; width:min(80vw,320px); height:100%;
      background:#03140c; border-left:1px solid rgba(0,255,128,.25);
      box-shadow:-12px 0 40px rgba(0,0,0,.45); z-index:1000; transition:right .25s ease;
      display:flex; flex-direction:column; padding:18px;
    }
    .drawer header{ all:unset; display:flex; align-items:center; justify-content:space-between; margin-bottom:8px }
    .drawer h2{ margin:0; font-size:18px; color:#9dffd2 }
    .drawer .close{
      background:none; border:1px solid rgba(0,255,128,.35); color:#b9ffdf; padding:6px 10px; border-radius:10px
    }
    .drawer nav{ display:flex; flex-direction:column; margin-top:12px }
    .drawer nav a{
      padding:14px 10px; border-bottom:1px solid rgba(0,255,128,.15);
      color:#b9ffdf; text-decoration:none; font-weight:800; letter-spacing:.02em; font-size:16px;
    }
    .drawer nav a:last-child{ border-bottom:0 }
    .drawer nav a:active{ background:rgba(0,255,128,.08) }
    .drawer-open .drawer{ right:0 }
    .drawer-open .drawer-overlay{ opacity:1; pointer-events:auto }

    /* Keep header off content */
    .spacer{ height:70px }

    /* ====== Drum Pad page content ====== */
    main{
      position:relative; z-index:1;
      max-width:1100px; margin:0 auto; padding:22px;
      min-height:calc(100vh - 70px);
      display:flex; flex-direction:column; gap:16px;
    }
    .card{
      background:rgba(0,0,0,0.6);
      border:2px solid rgba(0,255,128,0.25);
      border-radius:12px;
      box-shadow:0 0 30px rgba(0,255,128,0.2);
      padding: clamp(14px, 2.6vw, 22px);
    }
    .title-row{
      display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap;
      margin-bottom:8px;
    }
    h1{
      margin:0; color:var(--neon); text-shadow:0 0 18px var(--neon);
      font-size:clamp(22px,4.2vw,36px);
    }
    .status{ font-size:12px; opacity:.9 }

    .ctrl-row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .btn{
      appearance:none; border:1px solid rgba(0,255,128,.45); background:transparent;
      color:#b9ffdf; padding:10px 14px; border-radius:12px; font-weight:700; cursor:pointer;
    }
    .btn:hover{ color:#00ffea; border-color:#00ffea }
    .knob{display:flex; align-items:center; gap:10px}
    .knob input[type="range"]{width:180px; accent-color:var(--neon)}

    .grid{
      display:grid; gap:12px; margin-top:8px;
      grid-template-columns: repeat(2, 1fr);
    }
    @media(min-width:600px){ .grid{ grid-template-columns: repeat(5, 1fr); } }

    .pad{
      position:relative; isolation:isolate;
      display:grid; place-items:center;
      height:96px; border-radius:16px;
      border:1px solid rgba(0,255,128,.35);
      background:
        radial-gradient(120% 120% at 100% 0%, rgba(0,255,128,.08), transparent),
        linear-gradient(180deg, rgba(0,0,0,.25), rgba(0,0,0,.6)),
        #0a1f16;
      color:#76ffb2; font-weight:800; letter-spacing:.03em;
      box-shadow:0 6px 18px rgba(0,0,0,.45);
      user-select:none; -webkit-user-select:none;
      touch-action:manipulation; cursor:pointer;
      transition: transform .04s ease;
    }
    .pad:active{ transform: scale(.98); }
    .pad.kb:after{
      content: attr(data-key);
      position:absolute; top:6px; right:8px; font-size:12px; opacity:.6;
    }
    .pad.playing{
      box-shadow:0 0 0 2px rgba(0,255,153,.35), 0 0 24px rgba(0,255,153,.35);
      outline: 2px solid var(--neon);
    }
    .pad .label{ font-size:14px; line-height:1.2; opacity:.95; text-align:center; }

    .hint{text-align:center; font-size:12px; opacity:.8; margin:6px 0 0;}

    /* Responsive nav tweaks */
    @media (max-width: 960px){
      nav.site-nav{ display:none }
      .menu-btn{ display:inline-flex }
    }
  </style>
</head>
<body>

  <!-- Background video to match site -->
  <div class="video-bg" aria-hidden="true">
    <video autoplay loop muted playsinline preload="auto">
      <source src="video/bg2.mp4" type="video/mp4" />
    </video>
  </div>

  <!-- Top bar -->
  <header>
    <div class="brand">
      <img src="assets/favicon.png" alt="Ebmarah" />
      <span>Ebmarah</span>
    </div>
    <nav class="site-nav" aria-label="Primary">
      <a href="index.html">Home</a>
      <a href="music.html">Music</a>
      <a class="nav-link" href="live.html">Live</a>
      <a href="sample-packs.html">Sample Packs</a>
      <a href="about.html">About</a>
      <a href="virtual-rave-room.html">Virtual Rave Room</a>
      <a href="game.html">Game</a>
      <a href="drum-pad.html">BeEbmarah</a>
      <a href="contact.html">Contact</a>
    </nav>
    <button class="menu-btn" id="menuBtn" aria-expanded="false" aria-controls="drawer">Menu</button>
  </header>

  <!-- Offcanvas drawer -->
  <div class="drawer-overlay" id="drawerOverlay"></div>
  <aside class="drawer" id="drawer" role="dialog" aria-modal="true" aria-label="Site menu">
    <header>
      <h2>Menu</h2>
      <button class="close" id="drawerClose">Close</button>
    </header>
    <nav>
      <a href="index.html">Home</a>
      <a href="music.html">Music</a>
      <a class="nav-link" href="live.html">Live</a>
      <a href="sample-packs.html">Sample Packs</a>
      <a href="about.html">About</a>
      <a href="game.html">Game</a>
      <a href="drum-pad.html">BeEbmarah</a>
      <a href="contact.html">Contact</a>
    </nav>
  </aside>

  <div class="spacer"></div>

  <main>
    <!-- Controls card -->
    <section class="card">
      <div class="title-row">
        <h1>Unleash Your Inner Ebmarah</h1>
        <span class="status" id="status">tap ‚ÄúUnlock Audio‚Äù to begin</span>
      </div>
      <div class="ctrl-row">
        <button id="unlock" class="btn">üîì Unlock Audio</button>
        <button id="playLoop" class="btn" disabled>‚ñ∂Ô∏è Play Loop</button>
        <button id="stopLoop" class="btn" disabled>‚èπ Stop</button>
        <div class="knob" aria-label="Loop volume">
          <span>Vol</span>
          <input id="loopVol" type="range" min="0" max="1" step="0.01" value="0.7" disabled />
        </div>
      </div>
      <div class="hint">Keyboard: press <b>1‚Äì9</b> and <b>0</b>. On mobile, just tap the pads.</div>
    </section>

    <!-- Pad grid -->
    <section class="card">
      <div class="grid" id="padGrid" aria-label="Drum pads"></div>
    </section>
  </main>

  <!-- Optional mascot hook (kept consistent with your site) -->
  <script src="js/ebmarah-mascot.js"></script>
  <script>
    if (window.EbmarahMascot?.init) {
      EbmarahMascot.init({
        mode:'passive',
        position:'bottom-right',
        funnyLines:['beat the jungle ü•Å','bass bananas only üçå','gorilla certified üîä']
      });
    }
  </script>

  <!-- Drawer logic (same pattern as other pages) -->
  <script>
    (function(){
      const root=document.documentElement;
      const btn=document.getElementById('menuBtn');
      const drawer=document.getElementById('drawer');
      const overlay=document.getElementById('drawerOverlay');
      const closeBtn=document.getElementById('drawerClose');
      const openDrawer=()=>{root.classList.add('drawer-open');btn.setAttribute('aria-expanded','true');drawer.querySelector('a')?.focus();}
      const closeDrawer=()=>{root.classList.remove('drawer-open');btn.setAttribute('aria-expanded','false');btn.focus();}
      btn.addEventListener('click',openDrawer);
      closeBtn.addEventListener('click',closeDrawer);
      overlay.addEventListener('click',closeDrawer);
      window.addEventListener('keydown',e=>{if(e.key==='Escape')closeDrawer();});
    })();
  </script>

  <!-- Drum pad logic -->
  <script>
  (() => {
    // ===== Transport / sync (kept for compatibility, but no pad quantize/delay) =====
    const BPM = 140;
    const BEAT = 60 / BPM;
    let transportStart = 0;
    const HOLD_THRESHOLD_MS = 170; // tap vs hold threshold

    // Paths
    const DRUM_LOOP = 'assets/audio/loops/eb_loop_140.mp3';
    const SAMPLES = [
      // div values retained but unused for quantize now (kept to avoid UI/logic changes)
      { id: 'bass1',  label: '1/4th', key: '1', div: 1     },
      { id: 'bass2',  label: '1/4th', key: '2', div: 1     },
      { id: 'bass3',  label: '1/8th', key: '3', div: 0.5   },
      { id: 'bass4',  label: '1/8th', key: '4', div: 0.5   },
      { id: 'bass5',  label: '1/8t',  key: '5', div: 1/3   },
      { id: 'bass6',  label: '1/8t',  key: '6', div: 1/3   },
      { id: 'bass7',  label: '1/4th', key: '7', div: 1     },
      { id: 'bass8',  label: '1/8th', key: '8', div: 0.5   },
      { id: 'bass9',  label: '1/8th', key: '9', div: 0.5   },
      { id: 'bass10', label: '1/8t',  key: '0', div: 1/3   },
    ];
    const SAMPLE_BASE = 'assets/audio/pads/';

    // DOM
    const statusEl = document.getElementById('status');
    const unlockBtn = document.getElementById('unlock');
    const playBtn = document.getElementById('playLoop');
    const stopBtn = document.getElementById('stopLoop');
    const loopVol = document.getElementById('loopVol');
    const grid = document.getElementById('padGrid');

    // Build pads (no UI text changes)
    const frag = document.createDocumentFragment();
    SAMPLES.forEach(s => {
      const btn = document.createElement('button');
      btn.className = 'pad kb';
      btn.dataset.id = s.id;
      btn.dataset.key = s.key;
      btn.setAttribute('aria-label', s.label);
      btn.innerHTML = `<div class="label">${s.label}</div>`;
      setupPadGestures(btn, s);
      frag.appendChild(btn);
    });
    grid.appendChild(frag);

    // Keyboard mapping
    const keyToBtn = new Map();
    function mapKeys(){
      document.querySelectorAll('.pad').forEach(b => keyToBtn.set(b.dataset.key, b));
    }

    // Web Audio
    let ctx = null, loopGain = null, loopSource = null, loopBuffer = null;
    const padBuffers = new Map();

    unlockBtn.addEventListener('click', async () => {
      try {
        if (!ctx) ctx = new (window.AudioContext || window.webkitAudioContext)({ latencyHint: 'interactive' });
        transportStart = ctx.currentTime; // retained for compatibility
        status('loading audio‚Ä¶');

        loopGain = ctx.createGain();
        loopGain.gain.value = +loopVol.value;
        loopGain.connect(ctx.destination);

        // Load pads
        await Promise.all(SAMPLES.map(async s => {
          const buf = await fetchDecode(SAMPLE_BASE + s.id + '.mp3');
          if (buf) padBuffers.set(s.id, buf);
        }));

        // Load loop
        try {
          const res = await fetch(DRUM_LOOP);
          if (res.ok) {
            const ab = await res.arrayBuffer();
            loopBuffer = await ctx.decodeAudioData(ab);
          }
        } catch {}

        setEnabled(true);
        mapKeys();
        status('ready ‚Äì tap pads or press keys');
      } catch (e) {
        console.error(e);
        status('error unlocking audio (check console)');
      }
    });

    playBtn.addEventListener('click', () => {
      if (!ctx || !loopBuffer) { status('loop file not found'); return; }
      if (loopSource) { status('already playing'); return; }
      loopSource = ctx.createBufferSource();
      loopSource.buffer = loopBuffer;
      loopSource.loop = true;
      loopSource.connect(loopGain);
      loopSource.start();
      status('loop: playing');
    });

    stopBtn.addEventListener('click', stopLoop);

    function stopLoop(){
      if (loopSource) {
        try { loopSource.stop(); } catch {}
        try { loopSource.disconnect(); } catch {}
        loopSource = null;
        status('loop: stopped');
      }
    }

    loopVol.addEventListener('input', () => {
      if (loopGain) loopGain.gain.value = +loopVol.value;
    });

    // Helpers
    function status(t){ statusEl.textContent = t; }
    function setEnabled(on){
      playBtn.disabled = !on;
      stopBtn.disabled = !on;
      loopVol.disabled = !on;
      unlockBtn.disabled = on;
    }
    async function fetchDecode(url){
      try{
        const res = await fetch(url);
        if(!res.ok) return null;
        const ab = await res.arrayBuffer();
        return await ctx.decodeAudioData(ab);
      }catch{ return null; }
    }

    // ===== One-shot playback (tap/click) =====
    function playOneShot(id){
      if (!ctx) return;
      const buf = padBuffers.get(id);
      if (!buf) return;
      const src = ctx.createBufferSource();
      const g = ctx.createGain();
      g.gain.setValueAtTime(1.0, ctx.currentTime);
      src.buffer = buf;
      src.connect(g).connect(ctx.destination);
      src.start(); // immediate (no quantize) for tap behavior "like before"
    }

    // ===== Hold-to-loop engine (smooth crossfade, immediate start) =====
    const holds = new WeakMap(); // btn -> { stop(), isLooping }

    const PAD_GAIN = 1.0;
    const MIN_FADE = 0.02;
    const MAX_OVERLAP = 0.08;
    const MAX_VOICES = 4;

    function startHoldLoop(id, btn, startAt){
      if (!ctx) return;
      if (holds.get(btn)?.isLooping) return;

      const buf = padBuffers.get(id);
      if (!buf) { status(`missing: ${id}.wav`); flash(btn); return; }

      btn.classList.add('playing');

      const period = Math.max(buf.duration, MIN_FADE * 3);
      const fade = Math.min(MIN_FADE, period * 0.2);
      const overlap = Math.min(MAX_OVERLAP, Math.max(fade * 1.5, period * 0.04));

      const out = ctx.createGain();
      out.gain.value = 0;
      out.connect(ctx.destination);

      const level = PAD_GAIN;

      let alive = true;
      let nextTime = startAt ?? (ctx.currentTime + 0.002); // immediate start
      const voices = new Set();
      let timer = null;

      function scheduleVoice(at){
        if (!alive) return;
        if (voices.size > MAX_VOICES) {
          const first = voices.values().next().value;
          try { first.src.stop(); } catch {}
          voices.delete(first);
        }
        const src = ctx.createBufferSource();
        src.buffer = buf;
        const g = ctx.createGain();
        g.gain.setValueAtTime(0, at);
        g.gain.linearRampToValueAtTime(level, at + fade);

        const outStart = at + Math.max(0, period - overlap);
        g.gain.setValueAtTime(level, outStart);
        g.gain.linearRampToValueAtTime(0, outStart + fade);

        src.connect(g).connect(out);
        src.start(at);
        const stopAt = at + period + 0.25;
        src.stop(stopAt);

        const token = { src, g };
        voices.add(token);
        src.onended = () => voices.delete(token);
      }

      function tick(){
        if (!alive) return;
        const now = ctx.currentTime;
        while (nextTime < now + 0.25) {
          scheduleVoice(nextTime);
          nextTime += Math.max(0.01, period - overlap);
        }
        timer = setTimeout(tick, 25);
      }

      out.gain.cancelScheduledValues(ctx.currentTime);
      out.gain.setValueAtTime(0, ctx.currentTime);
      out.gain.linearRampToValueAtTime(1, ctx.currentTime + fade);

      scheduleVoice(nextTime);
      nextTime += Math.max(0.01, period - overlap);
      tick();

      const stop = () => {
        if (!alive) return;
        alive = false;
        clearTimeout(timer);
        const t = ctx.currentTime;
        out.gain.cancelScheduledValues(t);
        out.gain.setValueAtTime(out.gain.value, t);
        out.gain.linearRampToValueAtTime(0, t + fade);
        setTimeout(() => { try { out.disconnect(); } catch {} }, (fade + 0.1) * 1000);
        voices.forEach(v => { try { v.src.stop(); } catch {} });
        voices.clear();
        btn.classList.remove('playing');
        holds.delete(btn);
      };

      holds.set(btn, { stop, isLooping:true });
    }

    function stopHoldLoop(btn){
      const h = holds.get(btn);
      if (!h) return;
      h.stop?.();
    }

    function flash(btn){
      if (!btn) return;
      btn.classList.add('playing');
      setTimeout(() => btn.classList.remove('playing'), 110);
    }

    // ===== Pad gesture wiring (tap vs hold) =====
    function setupPadGestures(btn, spec){
      let holdTimer = null;
      let held = false;

      const onDown = (e) => {
        if (!ctx) return;
        e.preventDefault?.();
        held = true;

        // If still held after threshold -> start loop IMMEDIATELY (no delay/quantize)
        holdTimer = setTimeout(() => {
          if (!held) return;
          startHoldLoop(spec.id, btn); // immediate
        }, HOLD_THRESHOLD_MS);
      };

      const onUpCancel = () => {
        // If released before hold threshold -> treat as tap (one-shot)
        if (holdTimer) {
          clearTimeout(holdTimer);
          holdTimer = null;
          if (held && !holds.get(btn)?.isLooping) {
            playOneShot(spec.id);
          }
        }
        // If it *was* looping, stop it
        if (holds.get(btn)?.isLooping) {
          stopHoldLoop(btn);
        }
        held = false;
      };

      // Pointer events
      btn.addEventListener('pointerdown', onDown);
      btn.addEventListener('pointerup', onUpCancel);
      btn.addEventListener('pointercancel', onUpCancel);
      btn.addEventListener('pointerleave', onUpCancel);

      // Keyboard support: keydown starts gesture; keyup ends
      window.addEventListener('keydown', (e) => {
        if (!ctx) return;
        let key = e.key === ')' ? '0' : e.key;
        if (key !== spec.key) return;
        if (e.repeat) return;
        // mimic pointerdown
        held = true;
        holdTimer = setTimeout(() => {
          if (!held) return;
          startHoldLoop(spec.id, btn); // immediate
        }, HOLD_THRESHOLD_MS);
      });

      window.addEventListener('keyup', (e) => {
        let key = e.key === ')' ? '0' : e.key;
        if (key !== spec.key) return;
        onUpCancel();
      });
    }
  })();
  </script>
</body>
</html>

