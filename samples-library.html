<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Ebmarah – Fan Vocal Library</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" type="image/png" href="assets/favicon.png" />
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700&display=swap');
    :root { --neon:#00ff99; --ink:#e0ffe8; --bg:#020d07; }
    *{box-sizing:border-box}
    body{margin:0;font-family:'Orbitron',sans-serif;color:var(--ink);background:var(--bg)}
    header{position:sticky;top:0;background:rgba(0,0,0,.55);backdrop-filter:blur(10px);padding:12px 18px;border-bottom:1px solid rgba(0,255,128,.25);z-index:5}
    nav a{color:#76ffb2;text-decoration:none;margin-right:18px}
    h1{margin:16px 18px;text-shadow:0 0 14px var(--neon)}
    .wrap{width:min(1100px,94vw);margin:0 auto 40px}
    .controls{display:flex;gap:10px;flex-wrap:wrap;margin:10px 0;align-items:center}
    input,select,button,label{padding:9px;border-radius:8px;border:1px solid rgba(0,255,128,.35);background:rgba(0,0,0,.4);color:var(--ink)}
    input[type="checkbox"]{width:auto;accent-color:#00ff99}
    label.cb{border:none;background:transparent;padding:0;display:flex;align-items:center;gap:8px}
    button{cursor:pointer;font-weight:700}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:14px}
    .card{background:rgba(0,0,0,.45);border:1px solid rgba(0,255,128,.25);border-radius:14px;padding:10px}
    .meta{font-size:12px;opacity:.9;margin-top:6px;word-break:break-word}
    .row{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .tiny{font-size:12px;opacity:.85}
    .empty{padding:16px;text-align:center;opacity:.8}
    .group{grid-column:1 / -1;border:1px dashed rgba(0,255,128,.3);border-radius:16px;padding:8px 10px}
    .group h3{margin:4px 6px 10px;font-size:16px;color:#76ffb2}
    .group .grid{margin:0}
    .note{margin-top:8px;opacity:.75}
  </style>
</head>
<body>
  <header>
    <nav>
      <a href="index.html">Home</a>
      <a href="samples.html">Fan Vocal Booth</a>
      <a href="samples-library.html">Library</a>
    </nav>
  </header>

  <h1>Fan Vocal Library</h1>
  <div class="wrap">
    <div class="controls">
      <input id="q" placeholder="Search title or credit">
      <input id="day" type="date">
      <input id="sub" placeholder="Subfolder (e.g., Ebmarah)">
      <label class="cb"><input id="autoDiscover" type="checkbox"> Auto-discover subfolders</label>
      <button id="btnSearch">Search</button>
      <button id="btnClear">Clear</button>
    </div>

    <div id="list" class="grid"></div>

    <div style="display:grid;place-items:center;margin-top:14px">
      <button id="more">Load more</button>
      <div class="note tiny" id="pagingNote" style="display:none">
        Note: Auto-discover shows grouped results and disables paging.
      </div>
    </div>

    <p class="tiny" style="margin-top:10px">See something that breaks the rules? Click “Report” on the card to email the link for removal review.</p>
  </div>

  <!-- KEYS -->
  <script>
    // Your project values (you shared these already)
    window.SUPABASE_URL = "https://dcijcrwlxkxaexqmbtxu.supabase.co";
    window.SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRjaWpjcndseGt4YWV4cW1idHh1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkwOTA0MjAsImV4cCI6MjA3NDY2NjQyMH0.UmcHKU56ezlDpDs5emLgR0UkyWaa-VzdYr01bbeQ1cc";
  </script>

  <script>
  (function(){
    const listEl = document.getElementById('list');
    const qEl = document.getElementById('q');
    const dayEl = document.getElementById('day');
    const subEl = document.getElementById('sub');
    const autoEl = document.getElementById('autoDiscover');
    const moreBtn = document.getElementById('more');
    const pagingNote = document.getElementById('pagingNote');
    const btnSearch = document.getElementById('btnSearch');
    const btnClear = document.getElementById('btnClear');

    const BUCKET='fan-vocals';
    // If your objects are at bucket root, set '' instead of 'public/'.
    const prefixBase='public/';

    let offset=0, currentPrefix=prefixBase, lastBatchCount=0;

    // Build correct public URL (preserve slashes)
    function toPublicUrl(path){
      const safePath = path.split('/').map(encodeURIComponent).join('/');
      return `${window.SUPABASE_URL}/storage/v1/object/public/${BUCKET}/${safePath}`;
    }

    // Basic list (one page)
    async function list(prefix=prefixBase, limit=24, off=0){
      const res = await fetch(`${window.SUPABASE_URL}/storage/v1/object/list/${BUCKET}`, {
        method:'POST',
        headers:{
          'Authorization': `Bearer ${window.SUPABASE_ANON_KEY}`,
          'apikey': window.SUPABASE_ANON_KEY,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          prefix,
          limit,
          offset: off,
          sortBy: { column:'created_at', order:'desc' }
        })
      });
      if (!res.ok){
        const msg = await res.text().catch(()=>res.statusText);
        throw new Error(msg || `HTTP ${res.status}`);
      }
      return res.json();
    }

    // Read sibling JSON metadata if present
    async function fetchMeta(audioPath){
      const jsonPath = audioPath.replace(/\.(webm|mp3|m4a|wav)$/i, '.json');
      const url = toPublicUrl(jsonPath);
      try{
        const r = await fetch(url, {cache:'no-store'});
        if (!r.ok) throw 0;
        return await r.json();
      }catch{ return null; }
    }

    function esc(s){ return (s||'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }
    function mailtoReport(url){
      const subject = encodeURIComponent('Report submission');
      const body = encodeURIComponent(`Please review this clip for removal:\n\n${url}\n\nReason: `);
      return `mailto:info@ebmarah.com?subject=${subject}&body=${body}`;
    }

    function card({audioUrl, name, meta}){
      const title = esc(meta?.title || name);
      const credit = meta?.credit ? ` • by ${esc(meta.credit)}` : '';
      const badge = meta?.license === 'cc0' ? 'CC0' : 'Creator';
      const info = meta?.bpm ? ` • ${meta.bpm} BPM` : '';
      const report = mailtoReport(audioUrl);
      const copyId = 'copy_' + Math.random().toString(36).slice(2,9);
      return `
        <div class="card">
          <audio controls src="${audioUrl}"></audio>
          <div class="meta"><strong>${title}</strong>${credit}${info} • <span>${badge}</span></div>
          <div class="row">
            <a href="${audioUrl}" download>Download</a>
            <a href="${audioUrl}" target="_blank" rel="noopener">Open</a>
            <a href="${report}">Report</a>
            <button type="button" class="copy-btn" id="${copyId}" data-url="${audioUrl}">Copy URL</button>
          </div>
        </div>
      `;
    }

    function wireCopyButtons(scope=document){
      scope.querySelectorAll('.copy-btn').forEach(btn=>{
        btn.onclick = async () => {
          try { await navigator.clipboard.writeText(btn.dataset.url);
                btn.textContent='Copied!'; setTimeout(()=>btn.textContent='Copy URL',1200); }
          catch { btn.textContent='Failed'; setTimeout(()=>btn.textContent='Copy URL',1200); }
        };
      });
    }

    // Render a group with its cards
    function renderGroup(title, cardsHtml){
      return `
        <div class="group">
          <h3>${esc(title)}</h3>
          <div class="grid">
            ${cardsHtml}
          </div>
        </div>
      `;
    }

    // MAIN LOAD
    async function load(reset=false){
      if (reset){
        offset=0; lastBatchCount=0; listEl.innerHTML='';
      }

      // Build prefix: date + optional subfolder (unless auto-discover is on)
      const dateFilter = dayEl.value ? new Date(dayEl.value + 'T00:00:00Z') : null;
      const sub = (subEl.value || '').trim().replace(/^\/+|\/+$/g, ''); // sanitize
      const auto = !!autoEl.checked;

      currentPrefix = prefixBase; // 'public/' by default
      if (dateFilter){
        const y=dateFilter.getUTCFullYear();
        const m=String(dateFilter.getUTCMonth()+1).padStart(2,'0');
        const d=String(dateFilter.getUTCDate()).padStart(2,'0');
        currentPrefix = `${prefixBase}${y}/${m}/${d}/`;
      }
      if (!auto && sub) currentPrefix = `${currentPrefix}${sub}/`;

      // Auto mode disables paging (we load all in one go)
      moreBtn.style.display = auto ? 'none' : '';
      pagingNote.style.display = auto ? '' : 'none';

      if (auto){
        // Pull a generous number to cover a day’s worth; paginate until done or cap
        const pageSize = 200;
        let off = 0;
        let all = [];
        while (true){
          const batch = await list(currentPrefix, pageSize, off);
          all.push(...batch);
          if (batch.length < pageSize) break;
          off += batch.length;
          if (all.length >= 2000) break; // safety cap
        }

        // Group by first path segment (subfolder). Files directly in the date folder go to "(root)"
        const audioRe = /\.(webm|mp3|m4a|wav)$/i;
        const groups = new Map(); // name -> [{name, path}]
        const direct = [];

        for (const it of all){
          if (!audioRe.test(it.name)) continue;
          if (it.name.includes('/')){
            const [first, ...rest] = it.name.split('/');
            const arr = groups.get(first) || [];
            arr.push({ file: rest.join('/'), full: `${currentPrefix}${it.name}` });
            groups.set(first, arr);
          } else {
            direct.push({ file: it.name, full: `${currentPrefix}${it.name}` });
          }
        }

        if (groups.size === 0 && direct.length === 0){
          listEl.insertAdjacentHTML('beforeend', `<div class="empty card">No recordings found under <code>${esc(currentPrefix)}</code>.</div>`);
        } else {
          // Render direct files first (if any)
          if (direct.length){
            let cards = '';
            for (const it of direct){
              const audioUrl = toPublicUrl(it.full);
              const meta = await fetchMeta(it.full);
              const namePretty = it.file.replace(/_/g,' ');
              cards += card({audioUrl, name:namePretty, meta});
            }
            listEl.insertAdjacentHTML('beforeend', renderGroup('(root)', cards));
          }
          // Then render each subfolder group (alphabetical)
          const names = Array.from(groups.keys()).sort((a,b)=>a.localeCompare(b));
          for (const gName of names){
            const files = groups.get(gName);
            let cards = '';
            for (const it of files){
              const audioUrl = toPublicUrl(it.full);
              const meta = await fetchMeta(it.full);
              const namePretty = it.file.split('/').pop().replace(/_/g,' ');
              cards += card({audioUrl, name:namePretty, meta});
            }
            listEl.insertAdjacentHTML('beforeend', renderGroup(gName, cards));
          }
          wireCopyButtons(listEl);
        }
        return;
      }

      // Non-auto (flat) mode with paging
      const items = await list(currentPrefix, 24, offset);
      lastBatchCount = items.length;

      const audioItems = items.filter(it => /\.(webm|mp3|m4a|wav)$/i.test(it.name));
      if (reset && audioItems.length === 0){
        listEl.insertAdjacentHTML('beforeend', `<div class="empty card">No recordings found for this filter.</div>`);
      }

      for (const it of audioItems){
        const audioPath = `${currentPrefix}${it.name}`;
        const audioUrl = toPublicUrl(audioPath);
        const meta = await fetchMeta(audioPath);
        const namePretty = it.name.split('/').pop().replace(/_/g,' ');
        listEl.insertAdjacentHTML('beforeend', card({audioUrl, name:namePretty, meta}));
      }

      offset += items.length;
      moreBtn.disabled = lastBatchCount === 0;
      wireCopyButtons(listEl);
    }

    // Search filter (client-side text match)
    btnSearch.addEventListener('click', async ()=>{
      await load(true);
      const q = (qEl.value||'').toLowerCase();
      if (!q) return;
      Array.from(listEl.querySelectorAll('.card, .group')).forEach(node=>{
        const t = node.textContent.toLowerCase();
        node.style.display = t.includes(q) ? '' : 'none';
      });
    });

    btnClear.addEventListener('click', ()=>{ qEl.value=''; dayEl.value=''; subEl.value=''; autoEl.checked=false; load(true); });
    moreBtn.addEventListener('click', ()=>load(false));
    autoEl.addEventListener('change', ()=>load(true));

    // initial load
    load(true).catch(err=>{
      listEl.innerHTML = `<div class="card">Error loading library:<br><code>${(err?.message || String(err)).replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]))}</code></div>`;
    });
  })();
  </script>
</body>
</html>
