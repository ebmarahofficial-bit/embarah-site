<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Ebmarah – Fan Vocal Library</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" type="image/png" href="assets/favicon.png" />
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700&display=swap');
    :root { --neon:#00ff99; --ink:#e0ffe8; --bg:#020d07; }
    *{box-sizing:border-box}
    body{margin:0;font-family:'Orbitron',sans-serif;color:var(--ink);background:var(--bg)}
    header{position:sticky;top:0;background:rgba(0,0,0,.55);backdrop-filter:blur(10px);padding:12px 18px;border-bottom:1px solid rgba(0,255,128,.25);z-index:5}
    nav a{color:#76ffb2;text-decoration:none;margin-right:18px}
    h1{margin:16px 18px;text-shadow:0 0 14px var(--neon)}
    .wrap{width:min(1100px,94vw);margin:0 auto 40px}
    .controls{display:flex;gap:10px;flex-wrap:wrap;margin:10px 0}
    input,select,button{padding:9px;border-radius:8px;border:1px solid rgba(0,255,128,.35);background:rgba(0,0,0,.4);color:var(--ink)}
    button{cursor:pointer;font-weight:700}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:14px}
    .card{background:rgba(0,0,0,.45);border:1px solid rgba(0,255,128,.25);border-radius:14px;padding:10px}
    .meta{font-size:12px;opacity:.85;margin-top:6px;word-break:break-word}
    .row{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .tiny{font-size:12px;opacity:.85}
    .empty{padding:16px;text-align:center;opacity:.8}
  </style>
</head>
<body>
  <header>
    <nav>
      <a href="index.html">Home</a>
      <a href="samples.html">Fan Vocal Booth</a>
      <a href="samples-library.html">Library</a>
    </nav>
  </header>

  <h1>Fan Vocal Library</h1>
  <div class="wrap">
    <div class="controls">
      <input id="q" placeholder="Search title or credit">
      <input id="day" type="date">
      <button id="btnSearch">Search</button>
      <button id="btnClear">Clear</button>
    </div>
    <div id="list" class="grid"></div>
    <div style="display:grid;place-items:center;margin-top:14px">
      <button id="more">Load more</button>
    </div>
    <p class="tiny" style="margin-top:10px">See something that breaks the rules? Click “Report” on the card to email the link for removal review.</p>
  </div>

  <!-- KEYS -->
  <script>
    // Your project values (you shared these already)
    window.SUPABASE_URL = "https://dcijcrwlxkxaexqmbtxu.supabase.co";
    window.SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRjaWpjcndseGt4YWV4cW1idHh1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkwOTA0MjAsImV4cCI6MjA3NDY2NjQyMH0.UmcHKU56ezlDpDs5emLgR0UkyWaa-VzdYr01bbeQ1cc";
  </script>

  <script>
  (function(){
    const listEl = document.getElementById('list');
    const qEl = document.getElementById('q');
    const dayEl = document.getElementById('day');
    const moreBtn = document.getElementById('more');
    const btnSearch = document.getElementById('btnSearch');
    const btnClear = document.getElementById('btnClear');

    const BUCKET='fan-vocals';

    // If you stored files at the root, set this to ''.
    // If you used a 'public/' folder (recommended), leave as 'public/'.
    const prefixBase='public/';

    let offset=0, currentPrefix=prefixBase, lastBatchCount=0;

    // Fix #1: build a correct public URL (do NOT encode slashes)
    function toPublicUrl(path){
      // encode each segment, preserve slashes
      const safePath = path.split('/').map(encodeURIComponent).join('/');
      return `${window.SUPABASE_URL}/storage/v1/object/public/${BUCKET}/${safePath}`;
    }

    // Helper for list calls
    async function list(prefix=prefixBase, limit=24, off=0){
      const res = await fetch(`${window.SUPABASE_URL}/storage/v1/object/list/${BUCKET}`, {
        method:'POST',
        headers:{
          'Authorization': `Bearer ${window.SUPABASE_ANON_KEY}`,
          // Fix #2: include apikey header
          'apikey': window.SUPABASE_ANON_KEY,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          prefix,
          limit,
          offset: off,
          sortBy: { column:'created_at', order:'desc' }
        })
      });
      if (!res.ok){
        const msg = await res.text().catch(()=>res.statusText);
        throw new Error(msg || `HTTP ${res.status}`);
      }
      return res.json();
    }

    async function fetchMeta(audioPath){
      // expect a sibling JSON: same name, .json
      const jsonPath = audioPath.replace(/\.webm$/i, '.json');
      const url = toPublicUrl(jsonPath);
      try{
        const r = await fetch(url, {cache:'no-store'});
        if (!r.ok) throw 0;
        return await r.json();
      }catch{ return null; }
    }

    function esc(s){ return (s||'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }
    function mailtoReport(url){
      const subject = encodeURIComponent('Report submission');
      const body = encodeURIComponent(`Please review this clip for removal:\n\n${url}\n\nReason: `);
      return `mailto:info@ebmarah.com?subject=${subject}&body=${body}`;
    }

    function card({audioUrl, name, meta}){
      const title = esc(meta?.title || name);
      const credit = meta?.credit ? ` • by ${esc(meta.credit)}` : '';
      const badge = meta?.license === 'cc0' ? 'CC0' : 'Creator';
      const info = meta?.bpm ? ` • ${meta.bpm} BPM` : '';
      const report = mailtoReport(audioUrl);
      const copyId = 'copy_' + Math.random().toString(36).slice(2,9);
      return `
        <div class="card">
          <audio controls src="${audioUrl}"></audio>
          <div class="meta"><strong>${title}</strong>${credit}${info} • <span>${badge}</span></div>
          <div class="row">
            <a href="${audioUrl}" download>Download</a>
            <a href="${audioUrl}" target="_blank" rel="noopener">Open</a>
            <a href="${report}">Report</a>
            <button type="button" class="copy-btn" id="${copyId}" data-url="${audioUrl}">Copy URL</button>
          </div>
        </div>
      `;
    }

    async function load(reset=false){
      if (reset){
        offset=0;
        lastBatchCount=0;
        listEl.innerHTML='';
      }

      // Date -> folder like public/YYYY/MM/DD/
      const dateFilter = dayEl.value ? new Date(dayEl.value+'T00:00:00Z') : null;
      currentPrefix = prefixBase;
      if (dateFilter){
        const y=dateFilter.getUTCFullYear();
        const m=String(dateFilter.getUTCMonth()+1).padStart(2,'0');
        const d=String(dateFilter.getUTCDate()).padStart(2,'0');
        currentPrefix = `${prefixBase}${y}/${m}/${d}/`;
      }

      const items = await list(currentPrefix, 24, offset);
      lastBatchCount = items.length;

      const audioItems = items.filter(it => /\.webm$/i.test(it.name));
      if (reset && audioItems.length === 0){
        listEl.insertAdjacentHTML('beforeend', `<div class="empty card">No recordings found for this filter.</div>`);
      }

      for (const it of audioItems){
        const audioPath = `${currentPrefix}${it.name}`;
        const audioUrl = toPublicUrl(audioPath);
        const meta = await fetchMeta(audioPath);
        const namePretty = it.name.replace(/_/g,' ');
        listEl.insertAdjacentHTML('beforeend', card({audioUrl, name:namePretty, meta}));
      }

      offset += items.length;
      moreBtn.disabled = lastBatchCount === 0;

      // (re)wire copy buttons
      listEl.querySelectorAll('.copy-btn').forEach(btn=>{
        btn.onclick = async () => {
          try { await navigator.clipboard.writeText(btn.dataset.url);
                btn.textContent='Copied!'; setTimeout(()=>btn.textContent='Copy URL',1200); }
          catch { btn.textContent='Failed'; setTimeout(()=>btn.textContent='Copy URL',1200); }
        };
      });
    }

    btnSearch.addEventListener('click', async ()=>{
      await load(true);
      const q = (qEl.value||'').toLowerCase();
      if (!q) return;
      Array.from(listEl.children).forEach(card=>{
        const t = card.textContent.toLowerCase();
        card.style.display = t.includes(q) ? '' : 'none';
      });
    });

    btnClear.addEventListener('click', ()=>{ qEl.value=''; dayEl.value=''; load(true); });
    moreBtn.addEventListener('click', ()=>load(false));

    // initial load
    load(true).catch(err=>{
      listEl.innerHTML = `<div class="card">Error loading library:<br><code>${esc(err.message || String(err))}</code></div>`;
    });
  })();
  </script>
</body>
</html>
