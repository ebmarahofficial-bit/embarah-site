<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Ebmarah – Fan Vocal Library</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" type="image/png" href="assets/favicon.png" />
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700&display=swap');
    :root { --neon:#00ff99; --ink:#e0ffe8; --bg:#020d07; }
    *{box-sizing:border-box}
    body{margin:0;font-family:'Orbitron',sans-serif;color:var(--ink);background:var(--bg)}
    header{position:sticky;top:0;background:rgba(0,0,0,.55);backdrop-filter:blur(10px);padding:12px 18px;border-bottom:1px solid rgba(0,255,128,.25);z-index:5}
    nav a{color:#76ffb2;text-decoration:none;margin-right:18px}
    h1{margin:16px 18px;text-shadow:0 0 14px var(--neon)}
    .wrap{width:min(1100px,94vw);margin:0 auto 40px}
    .controls{display:flex;gap:10px;flex-wrap:wrap;margin:10px 0;align-items:center}
    input,select,button,label{padding:9px;border-radius:8px;border:1px solid rgba(0,255,128,.35);background:rgba(0,0,0,.4);color:var(--ink)}
    input[type="checkbox"]{width:auto;accent-color:#00ff99}
    label.cb{border:none;background:transparent;padding:0;display:flex;align-items:center;gap:8px}
    button{cursor:pointer;font-weight:700}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:14px}
    .card{background:rgba(0,0,0,.45);border:1px solid rgba(0,255,128,.25);border-radius:14px;padding:10px}
    .meta{font-size:12px;opacity:.9;margin-top:6px;word-break:break-word}
    .row{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .tiny{font-size:12px;opacity:.85}
    .empty{padding:16px;text-align:center;opacity:.8}
    .group{grid-column:1 / -1;border:1px dashed rgba(0,255,128,.3);border-radius:16px;padding:8px 10px}
    .group h3{margin:4px 6px 10px;font-size:16px;color:#76ffb2}
    .group .grid{margin:0}
    .note{margin-top:8px;opacity:.75}
  </style>
</head>
<body>
  <header>
    <nav>
      <a href="index.html">Home</a>
      <a href="samples.html">Fan Vocal Booth</a>
      <a href="samples-library.html">Library</a>
    </nav>
  </header>

  <h1>Fan Vocal Library</h1>
  <div class="wrap">
    <div class="controls">
      <input id="q" placeholder="Search title or credit">
      <input id="day" type="date">
      <input id="sub" placeholder="Subfolder (artist, e.g., Ebmarah)">
      <label class="cb"><input id="autoDiscover" type="checkbox"> Auto-discover subfolders</label>
      <button id="btnSearch">Search</button>
      <button id="btnClear">Clear</button>
    </div>

    <div id="list" class="grid"></div>

    <div style="display:grid;place-items:center;margin-top:14px">
      <button id="more">Load more</button>
      <div class="note tiny" id="pagingNote" style="display:none">
        Note: Auto-discover shows grouped results and disables paging.
      </div>
    </div>

    <p class="tiny" style="margin-top:10px">See something that breaks the rules? Click “Report” on the card to email the link for removal review.</p>
  </div>

  <!-- KEYS -->
  <script>
    // Your Supabase project (as shared)
    window.SUPABASE_URL = "https://dcijcrwlxkxaexqmbtxu.supabase.co";
    window.SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRjaWpjcndseGt4YWV4cW1idHh1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkwOTA0MjAsImV4cCI6MjA3NDY2NjQyMH0.UmcHKU56ezlDpDs5emLgR0UkyWaa-VzdYr01bbeQ1cc";
  </script>

  <script>
  (function(){
    const listEl = document.getElementById('list');
    const qEl = document.getElementById('q');
    const dayEl = document.getElementById('day');
    const subEl = document.getElementById('sub');
    const autoEl = document.getElementById('autoDiscover');
    const moreBtn = document.getElementById('more');
    const pagingNote = document.getElementById('pagingNote');
    const btnSearch = document.getElementById('btnSearch');
    const btnClear = document.getElementById('btnClear');

    const BUCKET='fan-vocals';

    // In your bucket, paths start at root (no "public/" folder).
    const prefixBase=''; // IMPORTANT: leave as empty string

    let offset=0, currentPrefix=prefixBase, lastBatchCount=0;

    const audioRe = /\.(webm|mp3|m4a|wav)$/i;

    // Build correct public URL (preserve slashes)
    function toPublicUrl(path){
      const safePath = path.split('/').map(encodeURIComponent).join('/');
      return `${window.SUPABASE_URL}/storage/v1/object/public/${BUCKET}/${safePath}`;
    }

    // Single page list against Supabase Storage
    async function list(prefix=prefixBase, limit=24, off=0){
      const res = await fetch(`${window.SUPABASE_URL}/storage/v1/object/list/${BUCKET}`, {
        method:'POST',
        headers:{
          'Authorization': `Bearer ${window.SUPABASE_ANON_KEY}`,
          'apikey': window.SUPABASE_ANON_KEY,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          prefix,
          limit,
          offset: off,
          sortBy: { column:'created_at', order:'desc' }
        })
      });
      if (!res.ok){
        const msg = await res.text().catch(()=>res.statusText);
        throw new Error(msg || `HTTP ${res.status}`);
      }
      return res.json(); // array of items (files and folder "markers" ending with '/')
    }

    // List ALL under a prefix by paging until done (safety capped)
    async function listAll(prefix, pageSize=200, cap=5000){
      let off=0, all=[];
      while(true){
        const batch = await list(prefix, pageSize, off);
        all.push(...batch);
        if (batch.length < pageSize) break;
        off += batch.length;
        if (all.length >= cap) break;
      }
      return all;
    }

    // Read sibling JSON metadata if present
    async function fetchMeta(audioPath){
      const jsonPath = audioPath.replace(/\.(webm|mp3|m4a|wav)$/i, '.json');
      const url = toPublicUrl(jsonPath);
      try{
        const r = await fetch(url, {cache:'no-store'});
        if (!r.ok) throw 0;
        return await r.json();
      }catch{ return null; }
    }

    function esc(s){ return (s||'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }
    function mailtoReport(url){
      const subject = encodeURIComponent('Report submission');
      const body = encodeURIComponent(`Please review this clip for removal:\n\n${url}\n\nReason: `);
      return `mailto:info@ebmarah.com?subject=${subject}&body=${body}`;
    }

    function card({audioUrl, name, meta}){
      const title = esc(meta?.title || name);
      const credit = meta?.credit ? ` • by ${esc(meta.credit)}` : '';
      const badge = meta?.license === 'cc0' ? 'CC0' : 'Creator';
      const info = meta?.bpm ? ` • ${meta.bpm} BPM` : '';
      const report = mailtoReport(audioUrl);
      const copyId = 'copy_' + Math.random().toString(36).slice(2,9);
      return `
        <div class="card">
          <audio controls src="${audioUrl}"></audio>
          <div class="meta"><strong>${title}</strong>${credit}${info} • <span>${badge}</span></div>
          <div class="row">
            <a href="${audioUrl}" download>Download</a>
            <a href="${audioUrl}" target="_blank" rel="noopener">Open</a>
            <a href="${report}">Report</a>
            <button type="button" class="copy-btn" id="${copyId}" data-url="${audioUrl}">Copy URL</button>
          </div>
        </div>
      `;
    }

    function wireCopyButtons(scope=document){
      scope.querySelectorAll('.copy-btn').forEach(btn=>{
        btn.onclick = async () => {
          try { await navigator.clipboard.writeText(btn.dataset.url);
                btn.textContent='Copied!'; setTimeout(()=>btn.textContent='Copy URL',1200); }
          catch { btn.textContent='Failed'; setTimeout(()=>btn.textContent='Copy URL',1200); }
        };
      });
    }

    // Render a group with its cards
    function renderGroup(title, cardsHtml){
      return `
        <div class="group">
          <h3>${esc(title)}</h3>
          <div class="grid">
            ${cardsHtml}
          </div>
        </div>
      `;
    }

    // MAIN LOAD
    async function load(reset=false){
      if (reset){
        offset=0; lastBatchCount=0; listEl.innerHTML='';
      }

      // Build prefix: artist (Subfolder) -> month/day
      const dateFilter = dayEl.value ? new Date(dayEl.value + 'T00:00:00Z') : null;
      const sub = (subEl.value || '').trim().replace(/^\/+|\/+$/g, ''); // artist
      const auto = !!autoEl.checked;

      // Paging only in non-auto mode
      moreBtn.style.display = auto ? 'none' : '';
      pagingNote.style.display = auto ? '' : 'none';

      if (auto){
        // Auto mode: require a date; scan ALL top-level artist folders and look under MM/DD
        if (!dateFilter){
          listEl.insertAdjacentHTML('beforeend', `<div class="empty card">Pick a date, then enable Auto-discover to scan all artists for that day.</div>`);
          return;
        }

        const m=String(dateFilter.getUTCMonth()+1).padStart(2,'0');
        const d=String(dateFilter.getUTCDate()).padStart(2,'0');

        // List top-level (artists)
        const top = await listAll(prefixBase, 500, 5000);
        const artistFolders = top.filter(it => it.name.endsWith('/')).map(it => it.name.replace(/\/$/, ''));

        const groups = new Map();

        for (const artist of artistFolders){
          const subPrefix = `${artist}/${m}/${d}/`;
          const subItems = await listAll(subPrefix, 200, 4000);
          const files = subItems.filter(f => !f.name.endsWith('/') && audioRe.test(f.name))
                                .map(f => ({ file: f.name, full: subPrefix + f.name }));
          if (files.length){
            groups.set(artist, files);
          }
        }

        if (groups.size === 0){
          listEl.insertAdjacentHTML('beforeend', `<div class="empty card">No recordings found for <code>${esc(m)}/${esc(d)}</code> across artists.</div>`);
        } else {
          for (const artist of Array.from(groups.keys()).sort((a,b)=>a.localeCompare(b))){
            const files = groups.get(artist);
            let cards = '';
            for (const it of files){
              const audioUrl = toPublicUrl(it.full);
              const meta = await fetchMeta(it.full);
              const namePretty = it.file.split('/').pop().replace(/_/g,' ');
              cards += card({audioUrl, name:namePretty, meta});
            }
            listEl.insertAdjacentHTML('beforeend', renderGroup(artist, cards));
          }
          wireCopyButtons(listEl);
        }
        return;
      }

      // Non-auto (manual) mode: artist optional, date optional
      currentPrefix = prefixBase;

      if (sub) currentPrefix += `${sub}/`;            // Ebmarah/
      if (dateFilter){
        const m=String(dateFilter.getUTCMonth()+1).padStart(2,'0');
        const d=String(dateFilter.getUTCDate()).padStart(2,'0');
        currentPrefix += `${m}/${d}/`;                // Ebmarah/09/28/
      }

      // Standard one-level list + paging
      const items = await list(currentPrefix, 24, offset);
      lastBatchCount = items.length;

      const audioItems = items.filter(it => !it.name.endsWith('/') && audioRe.test(it.name));
      if (reset && audioItems.length === 0){
        listEl.insertAdjacentHTML('beforeend', `<div class="empty card">No recordings found for this filter.</div>`);
      }

      for (const it of audioItems){
        const audioPath = `${currentPrefix}${it.name}`;
        const audioUrl = toPublicUrl(audioPath);
        const meta = await fetchMeta(audioPath);
        const namePretty = it.name.split('/').pop().replace(/_/g,' ');
        listEl.insertAdjacentHTML('beforeend', card({audioUrl, name:namePretty, meta}));
      }

      offset += items.length;
      moreBtn.disabled = lastBatchCount === 0;
      wireCopyButtons(listEl);
    }

    // Search filter (client-side text match)
    btnSearch.addEventListener('click', async ()=>{
      await load(true);
      const q = (qEl.value||'').toLowerCase();
      if (!q) return;
      Array.from(listEl.querySelectorAll('.card, .group')).forEach(node=>{
        const t = node.textContent.toLowerCase();
        node.style.display = t.includes(q) ? '' : 'none';
      });
    });

    btnClear.addEventListener('click', ()=>{ qEl.value=''; dayEl.value=''; subEl.value=''; autoEl.checked=false; load(true); });
    moreBtn.addEventListener('click', ()=>load(false));
    autoEl.addEventListener('change', ()=>load(true));

    // initial load
    load(true).catch(err=>{
      listEl.innerHTML = `<div class="card">Error loading library:<br><code>${(err?.message || String(err)).replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]))}</code></div>`;
    });
  })();
  </script>
</body>
</html>
